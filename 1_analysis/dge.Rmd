---
title: "DE Analysis"
author: "Ha Tran"
date: "22/08/2021"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      eval = TRUE,
                      fig.width = 11)
```

# Data Setup

### Load Library
```{r load libraries}
# working with data
library(dplyr)
library(magrittr)
library(readr)
library(tibble)
library(reshape2)
library(tidyverse)

# Visualisation:
library(kableExtra)
library(ggplot2)
library(grid)
library(pander)
library(cowplot)
library(pheatmap)
library(RColorBrewer)


# Custom ggplot 
library(ggpubr)
library(ggbiplot)
library(ggrepel)

# Bioconductor packages:
library(edgeR)
library(limma)
library(Glimma)

# Set ggplot theme
theme_set(theme_bw())

theme_update(
  legend.background = element_rect(fill = "transparent", colour = NA),
  legend.box.background = element_rect(fill = "transparent", colour = NA),
  
  panel.background = element_rect(fill = "transparent",colour = NA),
  plot.background = element_rect(fill = "transparent", colour = NA),
  
  plot.title = element_text(color = "gray20", size = 14, angle = 0, hjust = 0, vjust = .5, face = "bold"),
  plot.subtitle = element_text(color = "gray25", size = 12, angle = 0, hjust = 0, vjust = .5, face = "plain"),
  legend.title = element_text(color = "gray25", size = 11, angle = 0, hjust = 0, vjust = .5, face = "plain"),
  legend.text = element_text(color = "gray25", size = 11, angle = 0, hjust = 0, vjust = .5, face = "plain"),
  axis.text.x = element_text(color = "gray30", size = 10, angle = 0, hjust = .5, vjust = .5, face = "plain"),
  axis.text.y = element_text(color = "gray30", size = 10, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
  axis.title.x = element_text(color = "gray30", size = 12, angle = 0, hjust = .5, vjust = 0, face = "plain"),
  axis.title.y = element_text(color = "gray30", size = 12, angle = 90, hjust = .5, vjust = .5, face = "plain"))
```


### Import DGElist Data

DGElist object containing the raw feature count, sample metadata, and gene metadata, created in the Set Up stage. 

```{r importData}
# load DGElist previously created in the set up
dge <- readRDS(here::here("0_data/rds_object/dge.rds"))
```


# Differential Gene Expression Analysis

Here multiple methods of identifying differential expression will be compared. These methods include

1. Generalised Linear Model (GLM) with Likelihood Ratio Test (LRT),
2. Generalised Linear Model (GLM) with Quasi-likelihood F-tests (QLF), and
3. Limma-voom 

**These methods have been internally assessed and only the GLM:QLF + TREAT method will be run**

## Initial Parameterisation

The varying methods used to identify differential expression all rely on similar initial parameters. These include:

1. The Design Matrix,
2. Estimation of Dispersion, and
3. Contrast Matrix

### Design Matrix

The experimental design can be parameterised in a one-way layout where one coefficient is assigned to each group. The design matrix formulated below contains the predictors of each sample

```{r designMatrix}
#setup desgin matrix with sample_group
designMatrix <- model.matrix(~ 0 + sample_group,
                             data = dge$samples)

#remove "sample_group" from each column names
colnames(designMatrix) <- gsub("sample_group",
                               "",
                               colnames(designMatrix))

#remove "S48h_" from row names
rownames(designMatrix) <- gsub("S48h_",
                               "",
                               rownames(designMatrix))

designMatrix %>% saveRDS(here::here("0_data/rds_object/designMatrix.rds"))
#display the design matrix
designMatrix %>% as.data.frame()
```

### Estimating Dispersion
The negative binomial dispersion is calculated using the `bioConductor` recommended method of using the `estimateDisp` function. This method calculates the common dispersion, trended dispersion and tagwise dispersions in one run. This function also returns the formal `DGEList` object but with additional entries for the negative binomial dispersion for all genes.

The dispersion can then be visualised through the `plotBCV` function which shows the biological coefficient of variance (BCV) of each gene

```{r estimateDispersion}
estimateDispersion <- estimateDisp(y = dge,
                                   design = designMatrix,
                                   robust = TRUE)

# estimateDispersion$common.dispersion

#visualisation of dispersion estimate
edgeR::plotBCV(estimateDispersion)
invisible(dev.print(svg, here::here("2_plots/2_dge/estimate_dispersion.svg")))
```

### Contrast Matrix
The contrast matrix is required to provide a coefficient to each comparison and later used to test for significant differential expression with each comparison group

```{r constrastMatrix}
# make specific contrast
contrast <- limma::makeContrasts(
  Mac_vs_CKI = Mac - CKI,
  Nme_vs_CKI = Nme - CKI,
  Omt_vs_CKI = Omt - CKI,
  Tri_vs_CKI = Tri - CKI,
  UT_vs_CKI = UT - CKI,
  levels = designMatrix)

colnames(contrast) <- c("CKI-Mac vs CKI", "CKI-Nme vs CKI", "CKI-Omt vs CKI", "CKI-Tri vs CKI", "UT vs CKI")

contrast %>% saveRDS(here::here("0_data/rds_object/contrastMatrix.rds"))

contrast %>% as.data.frame()

#generate data frame of contrast colname for downstream analysis
comparison_group=colnames(contrast) %>% as.data.frame()
```

## Generalised Linear Model (GLM) with Quasi-likelihood F-Test (QLF)

The negative binomial model can be extended with quasi-likelihood methods to account for gene specific variablility from both biological and technical sources.

*While the likelihood ratio test is a more obvious choice for inferences with GLMs, the QL F-test is preferred as it reflects the uncertainty in estimating the dispersion for each gene. It provides more robust and reliable error rate control when the number of replicates is small. The QL dispersion estimation and hypothesis testing can be done by using the functions `glmQLFit()` and `glmQLFTest()`.*

### Fit GLM QLF model

*For the QL dispersions, estimation can be performed using the `glmQLFit` function. This returns a DGEGLM object containing the estimated values of the GLM coefficients for each gene, as well as the fitted mean-QL dispersion trend, the squeezed QL estimates and the prior degrees of freedom (df). These can be visualized with the `plotQLDisp` function.*

```{r fitGLMqlf}
#fit NB GLMQLF model to estimatedDespersion DGElist
fit_GLM_qlf <- edgeR::glmQLFit(y = estimateDispersion,
                               design = designMatrix,
                               robust = TRUE)
#view gene coefficients
# head(fit_GLM_qlf$coefficients)

#visualise
plotQLDisp(glmfit = fit_GLM_qlf)
invisible(dev.print(svg, here::here("2_plots/2_dge/qlf_dispersion.svg")))
```

### Apply QLF test
```{r applyQLF}
# Create list object
qlf=list()
qlf_decideTest=list()
qlf_unfiltered=list()
qlf_filtered=list()

for (i in 1:ncol(contrast)){
  #at each iteration, let x = name of each contrast group
  x=comparison_group[i,]

  #populate list with DGELRT object for every comparison
  qlf[[x]] <-
    edgeR::glmQLFTest(glmfit = fit_GLM_qlf, contrast = contrast[,x])

  #populate significant list with decide test
  qlf_decideTest[[x]] <-
    decideTests(qlf[[x]], p.value = 0.05, adjust.method = "fdr") %>% summary()

  #populate unfiltered list with list of all DE genes
  qlf_unfiltered[[x]] <-
    edgeR::topTags(object = qlf[[x]], n = Inf) %>% as.data.frame()

  #populate filtered list with list of significant DE genes
  qlf_filtered[[x]] <-
    edgeR::topTags(object = qlf[[x]], n = Inf, adjust.method = "fdr", p.value = 0.05, sort.by = "PValue") %>% as.data.frame()
}

# save rds object for use in downstream GO and KEGG analysis
qlf %>% saveRDS(here::here("0_data/rds_object/qlf.rds"))
# qlf_unfiltered %>% saveRDS(file = "0_data/rds_object/qlf_unfiltered.rds")
qlf_filtered %>% saveRDS(here::here("0_data/rds_object/qlf_filtered.rds"))

#save each unfiltered comparison group in the output directory

# dont need this
# writexl::write_xlsx(x = qlf_unfiltered,
                    # path = here:here("3_output/qlf_unfiltered.xlsx"))
writexl::write_xlsx(x = qlf_filtered, here::here("3_output/qlf_filtered.xlsx"))
```


#### Visualisation {.tabset}

##### P Value histogram
```{r pValueHistogram_qlf, eval=FALSE}
lapply(1:length(qlf),
       function(x){
         hist(x = qlf[[x]]$table$PValue,
              breaks = 50,
              main = paste0("P-Values qlf ", names(qlf[x])),
              xlab = "P-Value",
              col = "gray50")

invisible(dev.print(pdf, here::here(paste0("2_plots/2_dge/qlf_pValue_histogram_", names(qlf[x]), ".svg"))))
})

```

##### Mean-Difference plot
The differential expression can initial visualised through `plotMD` function, where the `logFC` is plotted against the relative abundance of the gene `logCPM`. Significant genes with FDR of 0.05 or less are highlighted.

**NOTE: this does not account for minimal `logFC` value**

```{r MAplotCustom_qlf, fig.height=7, eval=FALSE}
lapply(1:length(qlf_filtered),
       function(x) {

         #create data.frame specific for the custome MA plot
         MAplotData_qlf <- dplyr::select(as.data.frame(qlf_filtered[[x]]), logCPM, logFC, FDR)
         colnames(MAplotData_qlf) <- c("baseMeanLog2", "log2FoldChange", "padj")

         #create custom MA plot
         MAplot_qlf <- ggpubr::ggmaplot(
           data = MAplotData_qlf,
           fdr = 0.05,
           fc = 1.5,
           genenames = as.vector(rownames(MAplotData_qlf)),
           size = 1.5,
           alpha = 0.8,
           label.rectangle = TRUE,
           palette = c("firebrick3", "dodgerblue3", "gray50"),
           top = 5,
           select.top.method = c("padj", "fc"),
           main = "MA Plot from GLM-QLF ",
           legend = "bottom",
           submain = names(qlf_filtered[x]),
           xlab = expression("log"[2]*"CPM"),
           ylab = expression("log"[2]*"FC"),
           ylim = c(-8, 8),
           font.label = c(13, "italic", "gray30"),
           
           # ggtheme = ggplot2::theme_update(
           #   plot.title = element_text(color = "gray20", size = 24, angle = 0, hjust = 0, vjust = .5, face = "bold"),
           #   plot.subtitle = element_text(color = "gray25", size = 20, angle = 0, hjust = 0, vjust = .5, face = "plain"),
           #   legend.title = element_text(color = "gray25", size = 16, angle = 0, hjust = 0, vjust = .5, face = "plain"),
           #   legend.text = element_text(color = "gray25", size = 12, angle = 0, hjust = 0, vjust = .5, face = "plain"),
           #   axis.text.x = element_text(color = "gray30", size = 12, angle = 0, hjust = .5, vjust = .5, face = "plain"),
           #   axis.text.y = element_text(color = "gray30", size = 12, angle = 0, hjust = 1, vjust = 0, face = "plain"),
           #   axis.title.x = element_text(color = "gray30", size = 14, angle = 0, hjust = .5, vjust = 0, face = "plain"),
           #   axis.title.y = element_text(color = "gray30", size = 14, angle = 90, hjust = .5, vjust = .5, face = "plain")))
           # 
         
        
         #save MA plot
         # ggsave(paste0("MA_plot_qlf_", names(qlf_filtered[x]), ".svg"),
         #        plot = MAplot_qlf,
         #        path = "2_plots/2_dge/")

         #display plot
         MAplot_qlf
         })
```

##### Volcano Plot

Here the `ggplot` function can also be used to illustrate the DE genes significant `pValue` and `logFC`. In this instance, the significance is determined as genes with `PValue < 0.05` **and** `abs(logFC)>log(2)`.

```{r volcanoPlot_qlf, eval=FALSE}
lapply(1:length(qlf_filtered),
       function(x) {

         #add an extra column and determine whether the DE genes are significant
         qlf_filtered[[x]] <- qlf_filtered[[x]] %>% as.data.frame() %>%
           dplyr::mutate(Expression = case_when
                         (FDR <= 0.05 & logFC >= 1.5 ~ "Up-regulated",
                          FDR <= 0.05 & logFC <= -1.5 ~ "Down-regulated",
                          TRUE ~ "Insignificant"))

         #adding labels to top genes
         top <- 5
         top_genes_qlf <- bind_rows(
           qlf_filtered[[x]] %>%
             filter(Expression == 'Up-regulated') %>%
             arrange(FDR, desc(abs(logFC))) %>%
             head(top),
           qlf_filtered[[x]] %>%
             filter(Expression == 'Down-regulated') %>%
             arrange(FDR, desc(abs(logFC))) %>%
             head(top)
           )
         invisible(top_genes_qlf %>% as.data.frame())

         #generate volcano plot with the allDEgene data.frame
         volcano_plot_qlf <- qlf_filtered[[x]] %>%
           ggplot(aes(x = logFC,
                      y = -log(FDR, 10))) +
           geom_point(aes(colour = Expression),
                      size = 1.5,
                      alpha = 0.8,
                      show.legend = FALSE) +
           geom_label_repel(data = top_genes_qlf,
                            mapping = aes(logFC, -log(FDR,10), label = gene),
                            size = 3) +
           xlab(expression("log"[2]*"FC")) +
           ylab(expression("-log"[10]*"FDR")) +
           xlim(-8,8)+
           ylim(0,30)+
           scale_color_manual(values = c("dodgerblue3", "gray50", "firebrick3")) +
           guides(colour = guide_legend(override.aes = list(size=1.5))) +
           labs(title = "Volcano Plot: GLM-QLF",
                subtitle = paste0(names(qlf_filtered[x])),
                colour = "Expression")

         #save to directory
         # ggsave(paste0("volcano_plot_qlf_", names(qlf_filtered[x]), ".svg"),
         #        plot = volcano_plot_qlf,
         #        path = "2_plots/2_dge/")

         #display
         volcano_plot_qlf
         })
```


### Apply TREAT

```{r applyTreat}
# Create list object
treat=list()
treat_decideTest=list()
treat_unfiltered=list()
treat_filtered=list()

for (i in 1:ncol(contrast)){
  #at each iteration, let x = name of each contrast group
  x=comparison_group[i,]

  #populate list with DGELRT object for every comparison
  treat[[x]] <-
    edgeR::glmTreat(glmfit =  fit_GLM_qlf, contrast = contrast[,x], lfc = 1.5)

  #populate significant list with decide test
  treat_decideTest[[x]] <- decideTests(treat[[x]], p.value = 0.05, adjust.method = "fdr") %>% summary()


  #populate unfiltered list with list of all DE genes
  treat_unfiltered[[x]] <-
    edgeR::topTags(object = treat[[x]], n = Inf) %>% as.data.frame()

  #populate filtered list with list of significant DE genes
  treat_filtered[[x]] <-
    edgeR::topTags(object = treat[[x]], n = Inf, adjust.method = "fdr", p.value = 0.05, sort.by = "PValue") %>% as.data.frame()
}

# save rds object for use in downstream GO and KEGG analysis
treat %>% saveRDS(file = here::here("0_data/rds_object/treat.rds"))
treat_unfiltered %>% saveRDS(file = here::here("0_data/rds_object/treat_unfiltered.rds"))
treat_filtered %>% saveRDS(file = here::here("0_data/rds_object/treat_filtered.rds"))

#save each unfiltered comparison group in the output directory
# writexl::write_xlsx(x = treat_unfiltered,
                    # path = here::here("3_output/treat_unfiltered.xlsx"))
writexl::write_xlsx(x = treat_filtered,
                    path = here::here("3_output/treat_filtered.xlsx"))
```

#### Visualisation {.tabset}

##### P Value histogram
```{r pValueHistogram_treat}
lapply(1:length(treat),
       function(x){
         hist(x = treat[[x]]$table$PValue,
              breaks = 50,
              main = paste0("P-Values treat ", names(treat[x])),
              xlab = "P-Value",
              col = "gray50")

invisible(dev.print(pdf, here::here(paste0("2_plots/2_dge/treat_pValue_histogram_", names(treat[x]), ".svg"))))
})
```

##### Mean-Difference plot
The differential expression can initial visualised through `plotMD` function, where the `logFC` is plotted against the relative abundance of the gene `logCPM`. Significant genes with FDR of 0.05 or less are highlighted.

**NOTE: this does not account for minimal `logFC` value**

```{r MAplotCustom_treat, fig.height=7}
lapply(1:length(treat_unfiltered),
       function(x) {

         #create data.frame specific for the custome MA plot
         MAplotData_treat <- dplyr::select(as.data.frame(treat_unfiltered[[x]]), logCPM, logFC, FDR)
         colnames(MAplotData_treat) <- c("baseMeanLog2", "log2FoldChange", "padj")

         #create custom MA plot
         MAplot_treat <- ggpubr::ggmaplot(
           data = MAplotData_treat,
           fdr = 0.05,
           fc = 1.5,
           genenames = as.vector(rownames(MAplotData_treat)),
           size = 1.5,
           alpha = 0.8,
           label.rectangle = TRUE,
           palette = c("firebrick3", "dodgerblue3", "gray50"),
           top = 5,
           ylim = c(-8, 8),
           select.top.method = c("padj", "fc"),
           main = "MA Plot from GLM:QLF-TREAT",
           submain = names(treat_unfiltered[x]),
           legend = "bottom",
           legend.title = "Expression",
           xlab = expression("log"[2]*"CPM"),
           ylab = expression("log"[2]*"FC"),
           font.label = c(13, "italic", "gray30"), 
           ggtheme = theme_bw(),
           
           # ggtheme = ggplot2::theme_update(
           #   plot.title = element_text(color = "gray20", size = 24, angle = 0, hjust = 0, vjust = .5, face = "bold"),
           #   plot.subtitle = element_text(color = "gray25", size = 20, angle = 0, hjust = 0, vjust = .5, face = "plain"),
           #   legend.title = element_text(color = "gray25", size = 16, angle = 0, hjust = 0, vjust = .5, face = "plain"),
           #   legend.text = element_text(color = "gray25", size = 12, angle = 0, hjust = 0, vjust = .5, face = "plain"),
           #   axis.text.x = element_text(color = "gray30", size = 12, angle = 0, hjust = .5, vjust = .5, face = "plain"),
           #   axis.text.y = element_text(color = "gray30", size = 12, angle = 0, hjust = 1, vjust = 0, face = "plain"),
           #   axis.title.x = element_text(color = "gray30", size = 14, angle = 0, hjust = .5, vjust = 0, face = "plain"),
           #   axis.title.y = element_text(color = "gray30", size = 14, angle = 90, hjust = .5, vjust = .5, face = "plain"))
           )
         
         #save MA plot
         ggsave(filename = paste0("MA_plot_treat_", names(treat_unfiltered[x]), ".svg"),
                plot = MAplot_treat,
                width = 11,
                height = 7,
                path = here::here("2_plots/2_dge"))

         #display plot
         MAplot_treat
         })
```

##### Volcano Plot

Here the `ggplot` function can also be used to illustrate the DE genes significant `pValue` and `logFC`. In this instance, the significance is determined as genes with `PValue < 0.05` **and** `abs(logFC)>log(2)`.
```{r volcano_treat}
lapply(1:length(treat_unfiltered),
       function(x) {

         #add an extra column and determine whether the DE genes are significant
         treat_unfiltered[[x]] <- treat_unfiltered[[x]] %>% as.data.frame() %>%
           dplyr::mutate(Expression = case_when
                         (FDR <= 0.05 & logFC >= 1.5 ~ "Up-regulated",
                          FDR <= 0.05 & logFC <= -1.5 ~ "Down-regulated",
                          TRUE ~ "Insignificant"))

         #adding labels to top genes
         top <- 5
         top_genes_treat <- bind_rows(
           treat_unfiltered[[x]] %>%
             filter(Expression == 'Up-regulated') %>%
             arrange(FDR, desc(abs(logFC))) %>%
             head(top),
           treat_unfiltered[[x]] %>%
             filter(Expression == 'Down-regulated') %>%
             arrange(FDR, desc(abs(logFC))) %>%
             head(top)
           )
         invisible(top_genes_treat %>% as.data.frame())

         #generate volcano plot with the allDEgene data.frame
         volcano_plot_treat <- treat_unfiltered[[x]] %>%
           ggplot(aes(x = logFC,
                      y = -log(FDR, 10))) +
           geom_point(aes(colour = Expression),
                      size = 1.5,
                      alpha = 0.8,
                      show.legend = TRUE) +
           geom_label_repel(data = top_genes_treat,
                            mapping = aes(logFC, -log(FDR,10), label = gene),
                            size = 3) +
           xlab(expression("log"[2]*"FC")) +
           ylab(expression("-log"[10]*"FDR")) +
           xlim(-8,8)+
           ylim(0,30)+
           scale_color_manual(values = c("dodgerblue3", "gray50", "firebrick3")) +
           guides(colour = guide_legend(override.aes = list(size=1.5))) +
           labs(
             title = "Volcano Plot: GLM:QLF-TREAT",
                subtitle = paste0(names(treat_unfiltered[x])),
                colour = "Expression")

         #save to directory
         ggsave(paste0("volcano_plot_treat_", names(treat_unfiltered[x]), ".svg"),
                plot = volcano_plot_treat,
                width = 11,
                height = 7,
                path = here::here("2_plots/2_dge/"))

         #display
         volcano_plot_treat
         })

```

# Heatmap
```{r coolmap, fig.height=12, fig.width=8}
logCPM <- cpm(dge, prior.count=3, log=TRUE)
rownames(logCPM) <- dge$genes$gene
colnames(logCPM) <- paste(dge$samples$pretty_name, sep="-")

test3 <- join_all(list(treat_filtered$`UT vs CKI`,
                       treat_filtered$`CKI-Mac vs CKI`,
                       treat_filtered$`CKI-Nme vs CKI`,
                       treat_filtered$`CKI-Omt vs CKI`,
                       treat_filtered$`CKI-Tri vs CKI`), by = 'gene', type = 'inner')

logCPM <- logCPM[test3$gene[1:30],]
# colnames(logCPM) <- c("CKI")

my_palette <- colorRampPalette(c(
  rgb(32,121,226, maxColorValue = 255),
  # rgb(144,203,180, maxColorValue = 255), 
  rgb(254,238,229, maxColorValue = 255), 
  # rgb(251,192,52, maxColorValue = 255), 
  rgb(226,46,45, maxColorValue = 255)))(n = 201)

test <- as.factor(dge$samples$sample_type) %>% as.data.frame 
colnames(test) <- "Sample Type"
test$`Sample Type` <-  gsub("single_deletion", "Single Deletion", test$`Sample Type`)
test$`Sample Type` <-  gsub("UT", "Untreated", test$`Sample Type`)
rownames(test) <- colnames(logCPM) # check out the row names of annotation

sample_type <- RColorBrewer::brewer.pal(3, "Set1")
names(sample_type) <- c("CKI", "Single Deletion", "Untreated")
anno_colours <- list("Sample Type" = sample_type) 


pheatmap(mat = logCPM,
         cluster_cols = T,
         clustering_distance_rows = "euclidean",
         treeheight_row = 70,
         treeheight_col = 30,
         cutree_rows = 4,
         cutree_cols = 3,
         
         # legend_labels = "logFC",
         main = " " , 
         
         # fontsize = 14,
         # fontsize_row = 12,
         # fontsize_number = 10,
         # fontsize_col = 18,
         angle_col =90,
         
         annotation_col = test,
       
         annotation_names_col = FALSE,
         annotation_colors = anno_colours,
         # annotation_col = dge$samples$sample_type, %>%
         #   dplyr::select(SampleType = sample_type),
         scale = "row",
         # legend_breaks = c(seq(-2, 10, by = 2), max(logCPM)),
         # legend_labels = c(seq(-2, 10, by = 2), "logCPM\n"),
         # border_color = F,
         
         border_color = "gray70",
         color = my_palette,
         )
invisible(dev.print(device = svg, width = 8.5, height = 11, here::here("2_plots/2_dge/logCPM_heatmap.svg")))

```



