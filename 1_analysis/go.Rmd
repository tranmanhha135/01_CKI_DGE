---
title: "GO Analysis"
author: "Ha Tran"
date: "08/09/2021"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      eval = TRUE,
                      fig.width = 11)
```

# Data Setup

### Load Library
```{r load libraries}
# working with data
library(dplyr)
library(magrittr)
library(readr)
library(tibble)
library(reshape2)
library(tidyverse)

# Visualisation:
library(kableExtra)
library(ggplot2)
library(grid)
library(pander)
library(cowplot)

# Custom ggplot 
library(ggbiplot)
library(ggrepel)

# Bioconductor packages:
library(edgeR)
library(limma)
library(Glimma)
library(clusterProfiler)
library(org.Hs.eg.db)
# library(enrichplot)
library(biomaRt)

theme_set(theme_bw())

theme_update(
  legend.background = element_rect(fill = "transparent", colour = NA),
  legend.box.background = element_rect(fill = "transparent", colour = NA),
  
  panel.background = element_rect(fill = "transparent",colour = NA),
  plot.background = element_rect(fill = "transparent", colour = NA),
  
  plot.title = element_text(color = "gray20", size = 14, angle = 0, hjust = 0, vjust = .5, face = "bold"),
  plot.subtitle = element_text(color = "gray25", size = 12, angle = 0, hjust = 0, vjust = .5, face = "plain"),
  legend.title = element_text(color = "gray25", size = 11, angle = 0, hjust = 0, vjust = .5, face = "plain"),
  legend.text = element_text(color = "gray25", size = 11, angle = 0, hjust = 0, vjust = .5, face = "plain"),
  axis.text.x = element_text(color = "gray30", size = 10, angle = 0, hjust = .5, vjust = .5, face = "plain"),
  axis.text.y = element_text(color = "gray30", size = 10, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
  axis.title.x = element_text(color = "gray30", size = 12, angle = 0, hjust = .5, vjust = 0, face = "plain"),
  axis.title.y = element_text(color = "gray30", size = 12, angle = 90, hjust = .5, vjust = .5, face = "plain"))

```


### Import RDS Data

DGElist object containing the raw feature count, sample metadata, and gene metadata, created in the Set Up stage. 

```{r importData}
# load DGElist previously created in the set up
dge <- readRDS(here::here("0_data/rds_object/dge.rds"))
designMatrix <- readRDS(here::here("0_data/rds_object/designMatrix.rds"))
contrast <- readRDS(here::here("0_data/rds_object/contrastMatrix.rds"))

treat <- readRDS(here::here("0_data/rds_object/treat.rds"))
treat_filtered <- readRDS(here::here("0_data/rds_object/treat_filtered.rds"))

# qlf <- readRDS(here::here("0_data/rds_object/qlf.rds"))
# qlf_filtered <- readRDS(here::here("0_data/rds_object/qlf_filtered.rds"))
```

# Gene Ontology (GO) Enrichment Analysis

### Using the `clusterProfiler::enrichGO` package {.tabset}

GO enrichment analysis is performed using the DGE obtained from GLM:QLF + TREAT.

The top 30 most significant GO terms are displayed in relation to their respective comparison

```{r treat_enrichGO}
comparison_group=colnames(contrast) %>% as.data.frame()
goSummaries <- url("https://uofabioinformaticshub.github.io/summaries2GO/data/goSummaries.RDS") %>%
  readRDS() 
minPath <- 3

# Create list object
enrichGO_treat=list()
for (i in 1:ncol(contrast)){
  #at each iteration, let x = name of each contrast group
  x=comparison_group[i,]
  
  #populate the enrichGo list with all GO terms
  GOresults <- enrichGO(gene = treat_filtered[[x]]$entrezid,
                        keyType = "ENTREZID",
                        ont = "ALL",
                        OrgDb = org.Hs.eg.db,
                        pAdjustMethod = "fdr")

  enrichGO_treat[[x]] <- GOresults@result
  
  enrichGO_treat[[x]] <- enrichGO_treat[[x]] %>% rownames_to_column("id") %>%
  left_join(goSummaries) %>%
  dplyr::filter(shortest_path >= minPath) %>%
  column_to_rownames("id")

  #filter only significant GO terms. all terms already sig
  # enrichGO_treat_sig[[x]] <- enrichGO_treat[[x]] %>% filter(pvalue <= 0.05)
}

enrichGO_treat %>% saveRDS(file = here::here("0_data/rds_object/enrichGO_treat.rds"))

#save each unfiltered comparison group in the output directory
writexl::write_xlsx(x = enrichGO_treat,
                    path = here::here("3_output/enrichGO_treat.xlsx"))

```




#### Untreated vs CKI

```{r}
enrichGO_treat[["UT vs CKI"]][1:30,] %>% as.data.frame() %>% dplyr::select(-c("ID", "shortest_path", "longest_path", "terminal_node", "ontology")) %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover")) %>% scroll_box(height="600px")
```

#### CKI-Mac vs CKI

```{r}
enrichGO_treat[["CKI-Mac vs CKI"]][1:30,] %>% as.data.frame() %>% dplyr::select(-c("ID", "shortest_path", "longest_path", "terminal_node", "ontology")) %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover")) %>% scroll_box(height="600px")
```

#### CKI-Nme vs CKI

```{r}
enrichGO_treat[["CKI-Nme vs CKI"]][1:30,] %>% as.data.frame() %>% dplyr::select(-c("ID", "shortest_path", "longest_path", "terminal_node", "ontology")) %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover")) %>% scroll_box(height="600px")
```

#### CKI-Omt vs CKI

```{r}
enrichGO_treat[["CKI-Omt vs CKI"]][1:30,] %>% as.data.frame() %>% dplyr::select(-c("ID", "shortest_path", "longest_path", "terminal_node", "ontology")) %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover")) %>% scroll_box(height="600px")
```

#### CKI-Tri vs CKI

```{r}
enrichGO_treat[["CKI-Tri vs CKI"]][1:30,] %>% as.data.frame() %>% dplyr::select(-c("ID", "shortest_path", "longest_path", "terminal_node", "ontology")) %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover")) %>% scroll_box(height="600px")
```


### Enriched GO terms
```{r, fig.width=7, fig.height=8}
big_df=list()
for (i in 1:ncol(contrast)){
  #at each iteration, let x = name of each contrast group
  x=comparison_group[i,]
  
big_df[[x]] <- enrichGO_treat[[x]][1:7,]
}

#combine all list from big df into one
df <- as.data.frame(do.call(rbind, lapply(big_df, as.data.frame))) %>% rownames_to_column("group") %>% dplyr::select(-c("BgRatio", "pvalue", "geneID", "shortest_path", "longest_path", "terminal_node", "ontology" )) 

df <- df %>% separate(col = GeneRatio, into = c("numerator", "denomenator"), sep = "/")
df$numerator <- as.numeric(df$numerator)
df$denomenator <- as.numeric(df$denomenator)
df$'geneRatio' <- df$numerator / df$denomenator


#remove GO ID from group names
df$group <- gsub(pattern = "\\.GO:[0-9]*", "", df$group)

# Transform the column 'Description' into factors
df$Description <- as.factor(df$Description)

# Transform FDR values by -log10('FDR values')
df$'|log10(FDR)|' <- -(log10(df$p.adjust))

# Change factor order
df$group <- factor(df$group, levels = c("CKI-Mac vs CKI", "CKI-Nme vs CKI", "CKI-Omt vs CKI", "CKI-Tri vs CKI", "UT vs CKI"))
df$Description <- factor(df$Description, levels = rev(levels(df$Description)))

group.labs <- df$group

ggplot(df, aes(x = Description, y = group)) +
  geom_point(data=df,aes(x=Description, y=group, size = geneRatio, colour = `|log10(FDR)|`), alpha=.9)+
  # scale_y_discrete(labels =group.labs)+
  scale_color_gradient(low = "dodgerblue3", high = "firebrick3", limits=c(0, NA))+
  coord_flip()+
  theme_bw()+
  theme(axis.ticks.length=unit(-0.1, "cm"),
        axis.text.x = element_text(margin=margin(5,5,0,5,"pt"),angle = 45, hjust = 1),
        axis.text.y = element_text(margin=margin(5,5,5,5,"pt")),
        axis.text = element_text(color = "black"),
        axis.title.x=element_blank())+
  xlab(label = "")+
  labs(color=expression("-log"[10]*"FDR"), size="Gene Ratio")

ggsave(filename = "enrichedGO_treat.svg", width = 7, height = 6.5, plot = last_plot(), path = here::here("2_plots/3_go/"))

```


